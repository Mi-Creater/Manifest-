<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Courier Dashboard — Updated</title>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; background:#f4f4f4; }
    h1 { margin-bottom: 10px; }

    .controls { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .filters { background:#fff; padding:10px;border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,.08); display:flex; gap:12px; align-items:center; }
    .filters label { display:flex; align-items:center; gap:6px; font-size:14px; }

    .row { display: flex; justify-content: space-between; gap:12px; margin-bottom: 12px; }
    .box { width: 32%; }
    textarea { width: 100%; height: 180px; padding: 10px; resize: vertical; }

    #results { margin-top: 10px; width: 100%; border-collapse: collapse; background:#fff; }
    #results th, #results td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    #results thead th { background:#f0f0f0; }

    .summary { background:#fff; padding:10px; border-radius:6px; display:flex; gap:18px; align-items:center; margin-bottom:8px; }
    .summary div { font-weight:600; }

    .right { margin-left:auto; display:flex; gap:8px; }

    button { padding: 8px 12px; cursor: pointer; }
    input[type=text] { padding:6px 8px; }

    .hidden { display:none !important; }
</style>
</head>
<body>

<h1>Courier AWB Processing Dashboard</h1>

<div class="controls">
  <div class="filters">
    <label><input type="checkbox" id="selectAll" checked> Select All</label>
    <label><input type="checkbox" id="ffcChk" checked> FFC</label>
    <label><input type="checkbox" id="emxChk" checked> EMX</label>
    <label><input type="checkbox" id="logChk" checked> Logistic</label>
  </div>

  <div style="margin-left:12px; display:flex; gap:8px; align-items:center;">
    <label>AWB filter: <input type="text" id="awbFilter" placeholder="enter AWB to filter"></label>
    <button onclick="applyAwbFilter()">Apply</button>
    <button onclick="clearAwbFilter()">Clear</button>
  </div>

  <div class="right">
    <button onclick="generateResult()">Generate Result</button>
    <button onclick="exportExcel()">Export Manifest (Excel)</button>
    <button onclick="copyResult()">Copy Result</button>
    <button onclick="clearAll()">Clear All</button>
  </div>
</div>

<div class="row">
    <div class="box">
        <h3>FFC Courier</h3>
        <textarea id="ffc" placeholder="Paste AWBs, one per line"></textarea>
    </div>

    <div class="box">
        <h3>EMX Courier</h3>
        <textarea id="emx" placeholder="Paste AWBs, one per line"></textarea>
    </div>

    <div class="box">
        <h3>Logistic Courier</h3>
        <textarea id="logistic" placeholder="Paste AWBs, one per line"></textarea>
    </div>
</div>

<div class="summary" id="summary">
  <div id="totalAwb">Total AWB: 0</div>
  <div id="totalShip">Total Shipments: 0</div>
  <div id="totalPkg">Total Packages: 0</div>
  <div style="margin-left:auto; font-weight:500;">Manifest date: <span id="manifestDate"></span></div>
</div>

<table id="results">
  <!-- generated content -->
</table>

<script>
    // --- Persistence ---
    window.onload = () => {
        document.getElementById("ffc").value = localStorage.getItem("ffc") || "";
        document.getElementById("emx").value = localStorage.getItem("emx") || "";
        document.getElementById("logistic").value = localStorage.getItem("logistic") || "";
        document.getElementById('manifestDate').innerText = formatDate(new Date());

        // checkbox state
        ['ffcChk','emxChk','logChk','selectAll'].forEach(id=>{
          const v = localStorage.getItem(id);
          if(v!=='null' && v!==null) document.getElementById(id).checked = (v==='true');
        });

        // reflect select all
        document.getElementById('selectAll').addEventListener('change', onSelectAllToggle);
        ['ffcChk','emxChk','logChk'].forEach(id=> document.getElementById(id).addEventListener('change', onCourierToggle));

        // save on type
        ["ffc", "emx", "logistic"].forEach(id => {
            document.getElementById(id).addEventListener("input", () => {
                localStorage.setItem(id, document.getElementById(id).value);
            });
        });

        // save checkboxes on change
        ['ffcChk','emxChk','logChk','selectAll'].forEach(id=>{
          document.getElementById(id).addEventListener('change', ()=> localStorage.setItem(id, document.getElementById(id).checked));
        });

        generateResult();
    };

    function onSelectAllToggle(e){
      const on = e.target.checked;
      ['ffcChk','emxChk','logChk'].forEach(id=> document.getElementById(id).checked = on);
      localStorage.setItem('ffcChk',on);
      localStorage.setItem('emxChk',on);
      localStorage.setItem('logChk',on);
      generateResult();
    }

    function onCourierToggle(){
      // if any unchecked -> uncheck selectAll
      const all = ['ffcChk','emxChk','logChk'].every(id=> document.getElementById(id).checked);
      document.getElementById('selectAll').checked = all;
      localStorage.setItem('selectAll', all);
      generateResult();
    }

    function processData(raw) {
        let lines = raw.trim().split(/\n+/).map(x => x.trim()).filter(x => x !== "");
        let map = {};

        lines.forEach(a => {
            map[a] = (map[a] || 0) + 1;
        });

        return Object.keys(map).map(k => ({ awb: k, shipment: 1, package: map[k] }));
    }

    // apply AWB filter
    let currentAwbFilter = "";
    function applyAwbFilter(){
      currentAwbFilter = document.getElementById('awbFilter').value.trim();
      generateResult();
    }
    function clearAwbFilter(){ document.getElementById('awbFilter').value=''; currentAwbFilter=''; generateResult(); }

    function generateResult() {
        const ffcData = processData(document.getElementById("ffc").value);
        const emxData = processData(document.getElementById("emx").value);
        const logData = processData(document.getElementById("logistic").value);

        const showFFC = document.getElementById('ffcChk').checked;
        const showEMX = document.getElementById('emxChk').checked;
        const showLOG = document.getElementById('logChk').checked;

        // filter by AWB if provided (only keep matching AWB rows)
        function applyAwb(arr){ if(!currentAwbFilter) return arr; return arr.filter(r=> r.awb.includes(currentAwbFilter)); }
        const ffc = applyAwb(ffcData);
        const emx = applyAwb(emxData);
        const log = applyAwb(logData);

        // compute totals
        const totals = { awb:0, shipment:0, package:0 };
        const sumUnique = new Set();
        function addToTotals(arr){ arr.forEach(r=>{ sumUnique.add(r.awb); totals.shipment += r.shipment; totals.package += r.package; }); }
        if(showFFC) addToTotals(ffc);
        if(showEMX) addToTotals(emx);
        if(showLOG) addToTotals(log);
        totals.awb = sumUnique.size;

        document.getElementById('totalAwb').innerText = 'Total AWB: ' + totals.awb;
        document.getElementById('totalShip').innerText = 'Total Shipments: ' + totals.shipment;
        document.getElementById('totalPkg').innerText = 'Total Packages: ' + totals.package;

        // build table columns dynamically — each courier has 3 cols
        // header
        let headers = [];
        if(showFFC) headers.push({label:'FFC - AWB', id:'ffc_awb'},{label:'FFC - Shipments', id:'ffc_ship'},{label:'FFC - Packages', id:'ffc_pkg'});
        if(showEMX) headers.push({label:'EMX - AWB', id:'emx_awb'},{label:'EMX - Shipments', id:'emx_ship'},{label:'EMX - Packages', id:'emx_pkg'});
        if(showLOG) headers.push({label:'Logistic - AWB', id:'log_awb'},{label:'Logistic - Shipments', id:'log_ship'},{label:'Logistic - Packages', id:'log_pkg'});

        let html = '';
        // totals summary row in table (additional top row)
        html += '<thead><tr>';
        headers.forEach(h=> html += `<th>${h.label}</th>`);
        html += '</tr></thead>';

        // compute max rows among visible couriers
        const maxRows = Math.max( showFFC? ffc.length:0, showEMX? emx.length:0, showLOG? log.length:0 );

        html += '<tbody>';
        for(let i=0;i<maxRows;i++){
            html += '<tr>';
            if(showFFC){ const r = ffc[i]; html += r? `<td>${r.awb}</td><td>${r.shipment}</td><td>${r.package}</td>` : '<td></td><td></td><td></td>'; }
            if(showEMX){ const r = emx[i]; html += r? `<td>${r.awb}</td><td>${r.shipment}</td><td>${r.package}</td>` : '<td></td><td></td><td></td>'; }
            if(showLOG){ const r = log[i]; html += r? `<td>${r.awb}</td><td>${r.shipment}</td><td>${r.package}</td>` : '<td></td><td></td><td></td>'; }
            html += '</tr>';
        }
        // footer totals row inside table
        if(headers.length>0){
          html += '<tr style="font-weight:700; background:#fafafa;">';
          // show totals per courier
          if(showFFC){ const t = tally(ffc); html += `<td colspan="1">Total</td><td>${t.shipment}</td><td>${t.package}</td>`; }
          if(showEMX){ const t = tally(emx); html += `<td colspan="1">Total</td><td>${t.shipment}</td><td>${t.package}</td>`; }
          if(showLOG){ const t = tally(log); html += `<td colspan="1">Total</td><td>${t.shipment}</td><td>${t.package}</td>`; }
          html += '</tr>';
        }
        html += '</tbody>';

        document.getElementById('results').innerHTML = html;
    }

    function tally(arr){ const s = {awb:0, shipment:0, package:0}; const set = new Set(); arr.forEach(r=>{ set.add(r.awb); s.shipment += r.shipment; s.package += r.package; }); s.awb = set.size; return s; }

    function copyResult(){
        const table = document.getElementById("results");
        let range = document.createRange();
        range.selectNode(table);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        document.execCommand("copy");
        alert("Result Copied!");
    }

    function clearAll(){
        localStorage.removeItem('ffc'); localStorage.removeItem('emx'); localStorage.removeItem('logistic');
        document.getElementById("ffc").value = "";
        document.getElementById("emx").value = "";
        document.getElementById("logistic").value = "";
        document.getElementById('awbFilter').value=''; currentAwbFilter='';
        document.getElementById('results').innerHTML = '';
        document.getElementById('totalAwb').innerText = 'Total AWB: 0';
        document.getElementById('totalShip').innerText = 'Total Shipments: 0';
        document.getElementById('totalPkg').innerText = 'Total Packages: 0';
    }

    function formatDate(d){
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      return dd + '/' + mm + '/' + yyyy;
    }

    function exportExcel(){
        // We'll produce CSV that opens in Excel. Keep same layout as displayed and include totals and manifest date in filename.
        const showFFC = document.getElementById('ffcChk').checked;
        const showEMX = document.getElementById('emxChk').checked;
        const showLOG = document.getElementById('logChk').checked;
        const ffc = processData(document.getElementById("ffc").value);
        const emx = processData(document.getElementById("emx").value);
        const log = processData(document.getElementById("logistic").value);

        function applyAwb(arr){ if(!currentAwbFilter) return arr; return arr.filter(r=> r.awb.includes(currentAwbFilter)); }
        const f = applyAwb(ffc);
        const e = applyAwb(emx);
        const l = applyAwb(log);

        // Build header array
        let headers = [];
        if(showFFC) headers.push('FFC - AWB','FFC - Shipments','FFC - Packages');
        if(showEMX) headers.push('EMX - AWB','EMX - Shipments','EMX - Packages');
        if(showLOG) headers.push('Logistic - AWB','Logistic - Shipments','Logistic - Packages');

        let rows = [];
        rows.push(['Manifest Date:', formatDate(new Date())]);
        rows.push([]);
        if(headers.length>0) rows.push(headers);

        const maxRows = Math.max(showFFC? f.length:0, showEMX? e.length:0, showLOG? l.length:0);
        for(let i=0;i<maxRows;i++){
          let row = [];
          if(showFFC){ const r = f[i]; row.push(r? r.awb: '', r? r.shipment: '', r? r.package: ''); }
          if(showEMX){ const r = e[i]; row.push(r? r.awb: '', r? r.shipment: '', r? r.package: ''); }
          if(showLOG){ const r = l[i]; row.push(r? r.awb: '', r? r.shipment: '', r? r.package: ''); }
          rows.push(row);
        }

        // totals per courier
        let totalRow = [];
        if(showFFC){ const t = tally(f); totalRow.push('Total', t.shipment, t.package); }
        if(showEMX){ const t = tally(e); totalRow.push('Total', t.shipment, t.package); }
        if(showLOG){ const t = tally(l); totalRow.push('Total', t.shipment, t.package); }
        rows.push([]);
        rows.push(totalRow);

        // convert to CSV
        const csv = rows.map(r=> r.map(cell=> '"'+String(cell||'')+'"').join(',')).join('\n');

        const date = new Date();
        const dd = String(date.getDate()).padStart(2,'0');
        const mm = String(date.getMonth()+1).padStart(2,'0');
        const yyyy = date.getFullYear();
        const filename = `Manifest_${dd}-${mm}-${yyyy}.csv`;

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

</script>


<script>
// Generate sharable link (data URL)
function generateShareLink() {
    const tableHTML = document.getElementById('results').outerHTML;
    const blob = new Blob([tableHTML], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    document.getElementById('shareLink').value = url;
}
</script>
</div>

</body>
</html>
